name: YouTube to Drive Sync
on: [workflow_dispatch]
jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Tools
        run: |
          sudo curl -L https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp -o /usr/local/bin/yt-dlp
          sudo chmod a+rx /usr/local/bin/yt-dlp
          sudo apt-get install rclone -y

      - name: Setup Credentials
        run: |
          mkdir -p ~/.config/rclone
          echo "${{ secrets.RCLONE_CONFIG }}" > ~/.config/rclone/rclone.conf
          echo "${{ secrets.YT_COOKIES }}" > youtube-cookies.txt

      - name: Download & Upload
        run: |
          mkdir -p downloads
          # التحميل باستخدام الكوكيز وتخطي الفيديوهات غير المتاحة
          yt-dlp -f "bestvideo[ext=mp4]+bestaudio[ext=m4a]/best[ext=mp4]/best"                  --cookies youtube-cookies.txt                  --ignore-errors                  --no-warnings                  -o "downloads/%(title)s.%(ext)s"                  "https://www.youtube.com/playlist?list=PL7TpI0K9I87K5qQte9awzBO2QkeMl-UAN"
          
          # الرفع إلى درايف
          if [ -d "downloads" ] && [ "$(ls -A downloads)" ]; then
             rclone copy ./downloads/ gdrive:YouTube_Uploads -v --stats=10s
          else
             echo "⚠️ No accessible videos were found to download."
          fi
